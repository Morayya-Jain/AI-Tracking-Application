# BrainDock Build Workflow
#
# Automatically builds macOS and Windows executables when a version tag is pushed.
# Uploads the built artifacts to GitHub Releases.
#
# Usage:
#   1. Set these GitHub Secrets (Settings > Secrets > Actions):
#      - GEMINI_API_KEY (required)
#      - OPENAI_API_KEY (optional, for fallback/alternative AI)
#      - STRIPE_SECRET_KEY (optional, for payments)
#      - STRIPE_PUBLISHABLE_KEY (optional, for payments)
#      - STRIPE_PRICE_ID (optional, for payments)
#   2. Push a tag: git tag v1.0.0 && git push origin v1.0.0
#   3. The workflow will build both platforms and create a release
#
# The release will contain:
#   - BrainDock-macOS.dmg (macOS installer - drag to Applications)
#   - BrainDock-Windows.zip (Windows .exe)

name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.2.3, etc.
  workflow_dispatch:  # Allow manual trigger from GitHub UI
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0-test'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Build macOS app
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Generate icons
        run: python build/create_icons.py
      
      - name: Generate bundled keys module
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID }}
        shell: python
        run: |
          import os
          
          # Generate bundled_keys.py (primary method - imported by config.py)
          with open('bundled_keys_template.py', 'r') as f:
              content = f.read()
          content = content.replace('%%OPENAI_API_KEY%%', os.environ.get('OPENAI_API_KEY', ''))
          content = content.replace('%%GEMINI_API_KEY%%', os.environ.get('GEMINI_API_KEY', ''))
          content = content.replace('%%STRIPE_SECRET_KEY%%', os.environ.get('STRIPE_SECRET_KEY', ''))
          content = content.replace('%%STRIPE_PUBLISHABLE_KEY%%', os.environ.get('STRIPE_PUBLISHABLE_KEY', ''))
          content = content.replace('%%STRIPE_PRICE_ID%%', os.environ.get('STRIPE_PRICE_ID', ''))
          with open('bundled_keys.py', 'w') as f:
              f.write(content)
          print("bundled_keys.py generated with embedded keys")
          
          # Also generate runtime hook (backup method)
          with open('build/runtime_hook_template.py', 'r') as f:
              content = f.read()
          content = content.replace('%%OPENAI_API_KEY%%', os.environ.get('OPENAI_API_KEY', ''))
          content = content.replace('%%GEMINI_API_KEY%%', os.environ.get('GEMINI_API_KEY', ''))
          content = content.replace('%%STRIPE_SECRET_KEY%%', os.environ.get('STRIPE_SECRET_KEY', ''))
          content = content.replace('%%STRIPE_PUBLISHABLE_KEY%%', os.environ.get('STRIPE_PUBLISHABLE_KEY', ''))
          content = content.replace('%%STRIPE_PRICE_ID%%', os.environ.get('STRIPE_PRICE_ID', ''))
          with open('build/runtime_hook.py', 'w') as f:
              f.write(content)
          print("Runtime hook generated")
      
      - name: Build with PyInstaller
        run: |
          pyinstaller build/braindock.spec --noconfirm
      
      - name: Get version for DMG
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # Remove 'v' prefix if present for filename
          VERSION_NUM="${VERSION#v}"
          echo "VERSION_NUM=$VERSION_NUM" >> $GITHUB_OUTPUT
      
      - name: Create DMG installer
        run: |
          # Create staging folder with app and Applications symlink
          mkdir -p dist/dmg-staging
          cp -R dist/BrainDock.app dist/dmg-staging/
          ln -s /Applications dist/dmg-staging/Applications
          
          # Create DMG
          hdiutil create \
            -volname "BrainDock" \
            -srcfolder dist/dmg-staging \
            -ov \
            -format UDZO \
            dist/BrainDock-macOS.dmg
          
          # Clean up
          rm -rf dist/dmg-staging
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: BrainDock-macOS
          path: dist/BrainDock-macOS.dmg
          if-no-files-found: error

  # Build Windows app
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Generate icons
        run: python build/create_icons.py
      
      - name: Generate bundled keys module
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID }}
        shell: python
        run: |
          import os
          
          # Generate bundled_keys.py (primary method - imported by config.py)
          with open('bundled_keys_template.py', 'r') as f:
              content = f.read()
          content = content.replace('%%OPENAI_API_KEY%%', os.environ.get('OPENAI_API_KEY', ''))
          content = content.replace('%%GEMINI_API_KEY%%', os.environ.get('GEMINI_API_KEY', ''))
          content = content.replace('%%STRIPE_SECRET_KEY%%', os.environ.get('STRIPE_SECRET_KEY', ''))
          content = content.replace('%%STRIPE_PUBLISHABLE_KEY%%', os.environ.get('STRIPE_PUBLISHABLE_KEY', ''))
          content = content.replace('%%STRIPE_PRICE_ID%%', os.environ.get('STRIPE_PRICE_ID', ''))
          with open('bundled_keys.py', 'w') as f:
              f.write(content)
          print("bundled_keys.py generated with embedded keys")
          
          # Also generate runtime hook (backup method)
          with open('build/runtime_hook_template.py', 'r') as f:
              content = f.read()
          content = content.replace('%%OPENAI_API_KEY%%', os.environ.get('OPENAI_API_KEY', ''))
          content = content.replace('%%GEMINI_API_KEY%%', os.environ.get('GEMINI_API_KEY', ''))
          content = content.replace('%%STRIPE_SECRET_KEY%%', os.environ.get('STRIPE_SECRET_KEY', ''))
          content = content.replace('%%STRIPE_PUBLISHABLE_KEY%%', os.environ.get('STRIPE_PUBLISHABLE_KEY', ''))
          content = content.replace('%%STRIPE_PRICE_ID%%', os.environ.get('STRIPE_PRICE_ID', ''))
          with open('build/runtime_hook.py', 'w') as f:
              f.write(content)
          print("Runtime hook generated")
      
      - name: Build with PyInstaller
        run: |
          pyinstaller build/braindock.spec --noconfirm
      
      - name: Create ZIP archive
        run: |
          cd dist
          Compress-Archive -Path BrainDock -DestinationPath BrainDock-Windows.zip
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: BrainDock-Windows
          path: dist/BrainDock-Windows.zip
          if-no-files-found: error

  # Create GitHub Release with both artifacts
  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: BrainDock-macOS
          path: ./release
      
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: BrainDock-Windows
          path: ./release
      
      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: BrainDock ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## BrainDock ${{ steps.get_version.outputs.VERSION }}
            
            ### Downloads
            
            | Platform | Download |
            |----------|----------|
            | macOS | [BrainDock-macOS.dmg](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/BrainDock-macOS.dmg) |
            | Windows | [BrainDock-Windows.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/BrainDock-Windows.zip) |
            
            ### First-Time Launch Instructions
            
            **macOS:**
            1. Download and double-click the DMG file
            2. Drag BrainDock to the Applications folder
            3. Eject the DMG
            4. Open BrainDock from Applications (right-click â†’ Open the first time)
            
            **Windows:**
            1. Extract the ZIP file
            2. Run BrainDock.exe
            3. If SmartScreen appears, click "More info" then "Run anyway"
            
            ### Requirements
            - A webcam for focus monitoring
            - Internet connection for AI-powered detection
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, '-') }}
          files: |
            ./release/BrainDock-macOS.dmg
            ./release/BrainDock-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
